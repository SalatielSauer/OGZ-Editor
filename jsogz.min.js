/* JS object to .OGZ translator by @SalatielSauer. */

function floatHex(t){var e=new DataView(new ArrayBuffer(4));return e.setFloat32(0,t),Array.apply(null,{length:4}).map((t,r)=>(t=>("00"+t.toString(16)).slice(-2))(e.getUint8(r))).reverse().join("")}function intHex(t,e){return(t=parseInt(t)).toString(16).padStart(e,"0").match(/.{2}/g).reverse().join("")}function strHex(t){return t.split("").reduce((t,e)=>t+=e.charCodeAt(0).toString(16).padStart(2,"0"),"")}function hextoByte(t){return new Uint8Array(t.match(/.{2}/g).map(t=>parseInt(t,16)))}function getCubeIndex(t,e,r,n){let a=0;return a+=parseInt((t/(1<<n)).toString(2),8),a+=2*parseInt((e/(1<<n)).toString(2),8),a+=4*parseInt((r/(1<<n)).toString(2),8)}function getCubePos(t,e){let r=t.toString(8),n=[0,0,0];for(var a=0;a<r.length;a++){let t=parseInt(r[r.length-a-1],8);n[0]+=Math.floor(t/1)%2*2**a*(1<<e),n[1]+=Math.floor(t/2)%2*2**a*(1<<e),n[2]+=Math.floor(t/4)%2*2**a*(1<<e)}return n}function formathead(t,e,r,n,a,o){for(var i="4f4354411d00000024000000",s=0;s<arguments.length;s++)i+=intHex(arguments[s],8);return i}function formatvar(t,e,r){return intHex(t,2)+intHex(e.length,4)+strHex(e)+intHex(r.length,4)+strHex(r)}var entitiesarray=["entempty","light","mapmodel","playerstart","envmap","particles","sound","spotlight","gamespecific"];function formatent(t,e,r){r=entitiesarray.filter(t=>{if(r.match(t))return t})[0],t=t.split(" "),e=e.split(" ");return-1==entitiesarray.indexOf(r)&&(r="entempty"),floatHex(t[0])+floatHex(t[1])+floatHex(t[2])+intHex(e[0],4)+intHex(e[1],4)+intHex(e[2],4)+intHex(e[3],4)+intHex(e[4],4)+intHex(entitiesarray.indexOf(r),2)+"00"}var geometryarray=["children","empty","solid","normal","lodcube"],lastTextures=[1,1,1,1,1,1];function formatoctree(t){var e=t;"object"==typeof t&&(e=Object.keys(t)[0],t=t[Object.keys(t)[0]]);var r="";switch(e){case"children":return"00";case"empty":case"solid":case"normal":case"lodcube":var n=lastTextures;t.textures&&(lastTextures=n=t.textures.split(" ").map(t=>parseInt(t))),t.allfaces&&(lastTextures=n=Array(6).fill(n[0])),n.forEach(t=>{r+=intHex(t,4)});return intHex(geometryarray.indexOf(e),2)+r+intHex(0,2)}}function readOctree(t,e){var r="";!function t(e){(e=e.concat(Array(8-e.length).fill("empty"))).forEach(e=>{Array.isArray(e)?(r+=formatoctree("children"),t(e)):r+=formatoctree(e),1})}(t),e(r)}function getobjkeys(t){return t?Object.keys(t):[]}function JSOGZ(t,e,r){if("string"==typeof t){for(var n=0;n<entitiesarray.length;n++)enttype=new RegExp(entitiesarray[n],"g"),t=t.replace(enttype,t=>t+n++);try{t=JSON.parse(t)}catch(n){return void(r&&r(n))}}var a="";for(var o of(a+=formathead(t.mapsize||1024,getobjkeys(t.entities).length,0,0,0,getobjkeys(t.mapvars).length),getobjkeys(t.mapvars)))a+=formatvar(2,o,t.mapvars[o]);for(var o of(a+="0366707300",a+="00000000050002000400030005000700",getobjkeys(t.entities)))a+=formatent(t.entities[o].position,t.entities[o].attributes,o);switch(readOctree(t.geometry?t.geometry:[],t=>{a+=t}),e){case 0:default:return a;case 1:return hextoByte(a);case 2:if(window.pako)return window.pako.gzip(hextoByte(a));console.log("%c pako not found, you need it to get the data in .ogz format: https://github.com/nodeca/pako","color: red")}}